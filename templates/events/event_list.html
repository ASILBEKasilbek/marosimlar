{% extends 'base.html' %}

{% block title %}Tadbirlar ro‚Äòyxati{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <!-- ================= KATEGORIYA PILL BAR ================= -->
        <div class="col-12 mb-4">
            <h6 class="mb-2 fw-bold text-primary">Tadbir turlari</h6>
            <div class="d-flex flex-wrap gap-2">
                <a href="{% url 'event_list' %}" 
                   class="btn btn-light border rounded-pill px-3 py-1 shadow-sm fw-semibold {% if not request.GET.event_type %}active{% endif %}">
                    üåê Barchasi
                </a>
                {% for event_type in event_types %}
                    <button type="button" 
                            class="btn btn-light border rounded-pill px-3 py-1 shadow-sm fw-semibold event-type-btn" 
                            data-event-type-id="{{ event_type.id }}"
                            onclick="filterByEventType({{ event_type.id }})">
                        {{ event_type.name }}
                    </button>
                {% endfor %}
            </div>
        </div>

        <!-- ================= SIDEBAR ================= -->
        <div class="col-12 col-md-3 mb-4">
            <div class="border rounded-3 shadow-sm p-3 bg-white sticky-top" style="top: 16px;">
                <h6 class="fw-bold text-primary mb-3">üîé Filtrlash</h6>
                <form method="get" id="filter-form" class="d-flex flex-column gap-3">
                    <input type="hidden" name="event_type" id="event-type-input" value="{{ request.GET.event_type }}">
                    <div class="form-floating">
                        <input type="text" name="q" class="form-control" placeholder="Qidirish..." value="{{ request.GET.q }}">
                        <label>üîç Qidirish</label>
                    </div>
                    <div class="form-floating">
                        <input type="number" name="min_price" class="form-control" placeholder="Minimal narx" value="{{ request.GET.min_price }}">
                        <label>üíµ Minimal narx</label>
                    </div>
                    <div class="form-floating">
                        <input type="number" name="max_price" class="form-control" placeholder="Maksimal narx" value="{{ request.GET.max_price }}">
                        <label>üíµ Maksimal narx</label>
                    </div>
                    <div class="form-floating">
                        <input type="number" name="min_rating" class="form-control" min="1" max="5" value="{{ request.GET.min_rating }}">
                        <label>‚≠ê Minimal baho</label>
                    </div>
                    <button type="submit" class="btn btn-primary mt-2 w-100 shadow-sm">Filtrlash</button>
                </form>
            </div>
        </div>

        <!-- ================= MAIN CONTENT ================= -->
        <div class="col-12 col-md-9">
            <!-- SORT DROPDOWN -->
            <div class="d-flex justify-content-end mb-3">
                <div class="dropdown">
                    <button class="btn btn-outline-primary dropdown-toggle shadow-sm" type="button" data-bs-toggle="dropdown">
                        Tartiblash
                    </button>
                    <ul class="dropdown-menu shadow">
                        <li><a class="dropdown-item" href="?sort=popular{% if request.GET.event_type %}&event_type={{ request.GET.event_type }}{% endif %}">üî• Ommabop</a></li>
                        <li><a class="dropdown-item" href="?sort=cheap{% if request.GET.event_type %}&event_type={{ request.GET.event_type }}{% endif %}">üí∏ Arzon</a></li>
                        <li><a class="dropdown-item" href="?sort=expensive{% if request.GET.event_type %}&event_type={{ request.GET.event_type }}{% endif %}">üíé Qimmat</a></li>
                        <li><a class="dropdown-item" href="?sort=top-rated{% if request.GET.event_type %}&event_type={{ request.GET.event_type }}{% endif %}">‚≠ê Yuqori baholangan</a></li>
                    </ul>
                </div>
            </div>

            <!-- ================= CARD GRID ================= -->
            <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 g-3">
                {% for service in services %}
                <div class="col">
                    <div class="card h-100 shadow-sm hover-shadow">
                        {% if service.provider.profile.image %}
                        <img src="{{ service.provider.profile.image.url }}" class="card-img-top" alt="{{ service.title }}" loading="lazy">
                        {% endif %}
                        <div class="card-body">
                            <h6 class="card-title fw-bold mb-2">{{ service.title }}</h6>
                            <p class="text-muted small mb-3">{{ service.description|truncatewords:12 }}</p>
                            <a href="{% url 'service_detail' slug=service.slug %}" 
                               class="btn btn-outline-primary btn-sm w-100">Batafsil ‚Üí</a>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="col-12 text-center">
                    <p class="text-muted">Hech qanday xizmat topilmadi.</p>
                </div>
                {% endfor %}
            </div>

            <!-- ================= PAGINATION ================= -->
            {% if services.has_other_pages %}
            <nav aria-label="Page navigation" class="mt-4">
                <ul class="pagination justify-content-center">
                    {% if services.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ services.previous_page_number }}{% if request.GET.event_type %}&event_type={{ request.GET.event_type }}{% endif %}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.min_price %}&min_price={{ request.GET.min_price }}{% endif %}{% if request.GET.max_price %}&max_price={{ request.GET.max_price }}{% endif %}{% if request.GET.min_rating %}&min_rating={{ request.GET.min_rating }}{% endif %}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}">Oldingi</a>
                    </li>
                    {% endif %}
                    {% for num in services.paginator.page_range %}
                    <li class="page-item {% if services.number == num %}active{% endif %}">
                        <a class="page-link" href="?page={{ num }}{% if request.GET.event_type %}&event_type={{ request.GET.event_type }}{% endif %}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.min_price %}&min_price={{ request.GET.min_price }}{% endif %}{% if request.GET.max_price %}&max_price={{ request.GET.max_price }}{% endif %}{% if request.GET.min_rating %}&min_rating={{ request.GET.min_rating }}{% endif %}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}">{{ num }}</a>
                    </li>
                    {% endfor %}
                    {% if services.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ services.next_page_number }}{% if request.GET.event_type %}&event_type={{ request.GET.event_type }}{% endif %}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.min_price %}&min_price={{ request.GET.min_price }}{% endif %}{% if request.GET.max_price %}&max_price={{ request.GET.max_price }}{% endif %}{% if request.GET.min_rating %}&min_rating={{ request.GET.min_rating }}{% endif %}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}">Keyingi</a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
        </div>
    </div>
</div>

<!-- ================= STYLES ================= -->
<style>
/* Base styles */
body {
    overscroll-behavior: none;
}

/* Category buttons */
.event-type-btn.active, .event-type-btn:hover {
    background: linear-gradient(135deg, #0d6efd, #6610f2);
    color: white;
    border-color: transparent;
    box-shadow: 0 4px 12px rgba(13,110,253,0.3);
}

/* Card styles */
.card {
    border: none;
    border-radius: 12px;
    overflow: hidden;
    background: #fff;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}
.card-img-top {
    height: 160px;
    object-fit: cover;
}
.card-body {
    padding: 16px;
}
.hover-shadow:hover {
    transform: translateY(-6px);
    box-shadow: 0 8px 16px rgba(0,0,0,0.15);
}

/* Pagination */
.pagination .page-link {
    border-radius: 8px;
    margin: 0 4px;
    color: #0d6efd;
}
.pagination .page-item.active .page-link {
    background: #0d6efd;
    border-color: #0d6efd;
}
.pagination .page-link:hover {
    background: #e9ecef;
}

/* Responsive */
@media (max-width: 767.98px) {
    .sticky-top { position: relative; top: auto !important; }
    .card-img-top { height: 140px; }
    .card-body { padding: 12px; }
    .form-floating input { font-size: 14px; }
    .btn-sm { font-size: 0.85rem; }
}

/* High-density displays */
@media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
    .card { box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
}
</style>

<!-- ================= JAVASCRIPT ================= -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Event type filter
    window.filterByEventType = function(eventTypeId) {
        const input = document.getElementById('event-type-input');
        input.value = eventTypeId;
        document.getElementById('filter-form').submit();
    };

    // Highlight active event type button
    const eventTypeId = '{{ request.GET.event_type }}';
    if (eventTypeId) {
        const activeButton = document.querySelector(`.event-type-btn[data-event-type-id="${eventTypeId}"]`);
        if (activeButton) {
            document.querySelectorAll('.event-type-btn').forEach(btn => btn.classList.remove('active'));
            activeButton.classList.add('active');
        }
    }
});
</script>
{% endblock %}